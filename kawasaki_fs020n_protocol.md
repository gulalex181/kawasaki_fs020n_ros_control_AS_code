# Протокол взаимодействия с манипулятором kawasaki_fs020n

- [Протокол взаимодействия с манипулятором kawasaki_fs020n](#%D0%BF%D1%80%D0%BE%D1%82%D0%BE%D0%BA%D0%BE%D0%BB-%D0%B2%D0%B7%D0%B0%D0%B8%D0%BC%D0%BE%D0%B4%D0%B5%D0%B9%D1%81%D1%82%D0%B2%D0%B8%D1%8F-%D1%81-%D0%BC%D0%B0%D0%BD%D0%B8%D0%BF%D1%83%D0%BB%D1%8F%D1%82%D0%BE%D1%80%D0%BE%D0%BC-kawasakifs020n)
  - [Запрос клиента (сервер - робот, клиент - PC)](#%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81-%D0%BA%D0%BB%D0%B8%D0%B5%D0%BD%D1%82%D0%B0-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80---%D1%80%D0%BE%D0%B1%D0%BE%D1%82-%D0%BA%D0%BB%D0%B8%D0%B5%D0%BD%D1%82---pc)
    - [Порядок использования команд](#%D0%BF%D0%BE%D1%80%D1%8F%D0%B4%D0%BE%D0%BA-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F-%D0%BA%D0%BE%D0%BC%D0%B0%D0%BD%D0%B4)
    - [Команды](#%D0%BA%D0%BE%D0%BC%D0%B0%D0%BD%D0%B4%D1%8B)
  - [Ответ сервера (сервер - робот, клиент - PC)](#%D0%BE%D1%82%D0%B2%D0%B5%D1%82-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B0-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80---%D1%80%D0%BE%D0%B1%D0%BE%D1%82-%D0%BA%D0%BB%D0%B8%D0%B5%D0%BD%D1%82---pc)

Протокол соответствует управляющему коду на языке AS, зашитому в память манипулятора.

## Запрос клиента (сервер - робот, клиент - PC)

Формат строки запроса:

```
VERSION COMMAND COUNT_OF_ARGS ARGS
```

В качестве ответа сервера всегда, кроме случаев ошибки соединения, приходит текущий статус робота (см. ответ сервера ниже).

> VERSION

```
VERSION = 1040 (в AS программе идет сравнение с таким значением)
```

Если версию послать другую, то просто получим в ответе текущее состояние (включая значения углов шарниров) без каких-либо действий робота.

> COMMAND

```
COMMAND = 1 | 2 | 3 | 4 | 5 | 6 | 7 | 255
```

> COUNT_OF_ARGS

Количество аргументов (ARGS).

### Порядок использования команд

Для движения нужно сначала начать программу движения командой 1. Далее нужно отправлять последовательно позиции командой 6 (или 7).

Если в течении 5 секунд сервер не получает новую команду, то это аналогично команде 255.

Если клиент не принимает запрос за 2 секунды, то это аналогично команде 255.

Если между командами 6 (или 7) послать команду:
1 - по завершению последнего движения робот остановится, пока либо не придет новая команда 6 (или 7),
2 - выполнение программы движения прекратится (ее нужно будет запускать заново), причем движение робота прервется там, где робот находится в данный момент,
5 - отменится текущее движение робота,
255 - выполнение программы движения прекратится, причем движение робота прервется там, где робот находится в данный момент, и закроется сеанс связи.

### Команды

1: начать выполнение программы движения робота

Запустится программа, которая приведет к движению робота, если будет работать штатно (будет получать команду 6 или 7).

Чтобы движение могло начаться, нужно:
- подать питание на двигатели (кнопка на панель контроллера)
- переключить RUN/HOLD на панели контроллера в состояние RUN
- переключить TEACH/REPEAT на панели контроллера в состояние REPEAT
- выключить переключатель TEACH LOCK на пульте

пример:
```
"1040 1 0"
```
| VERSION | COMMAND | COUNT_OF_ARGS |
| ------- | ------- | ------------- |
|    1040 |       1 |             0 |

2: прервать выполнение программы движения робота

Робот остановится там, где он был в данный момент. Соединение не разрывается. Чтобы продолжить движение, нужно опять использовать команду 1.

пример:
```
"1040 2 0"
```
| VERSION | COMMAND | COUNT_OF_ARGS |
| ------- | ------- | ------------- |
|    1040 |       2 |             0 |

3: установить заданную консольную скорость и включить использование абсолютной скорости

пример:
```
"1040 3 1 40"
```
| VERSION | COMMAND | COUNT_OF_ARGS | ARG1 |
| ------- | ------- | ------------- | ---- |
|    1040 |       3 |             1 |  40  |


4: не использовать (никакой полезной функции)

5: отменить текущее движение робота

Робот немедленно остановится. Если следующей командой будет 6 (или 7), то движение продолжится.

пример:
```
"1040 5 0"
```
| VERSION | COMMAND | COUNT_OF_ARGS |
| ------- | ------- | ------------- |
|    1040 |       5 |             0 |

6: переместить робот с joint интерполяцией в позицию, которой соответствуют заданные значения углов шарниров

пример:
```
"1040 6 9 0 0 0 0 0 0 0 0 0"
```
| VERSION | COMMAND | COUNT_OF_ARGS | ARG1 | ARG2 | ARG3 | ARG4 | ARG5 | ARG6 | ARG7 | ARG8 | ARG9 |
| ------- | ------- | ------------- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
|    1040 |       6 |             9 |    0 |    0 |    0 |    0 |    0 |    0 |    0 |    0 |    0 |

Аргументы с 1 по 3 в этой команде не используются, т.е. могут быть любыми.
Аргументы с 4 по 9 это значения углов шарниров с JT1 по JT6.

Углы измеряется в градусах.

7: другой вид движения

FIXME (информация не полная, надо понять, что происходит в коде AS)

Аргументы с 4 по 9 это значения углов шарниров с JT1 по JT6.
Аргументы с 10 по 15 это скорости соответствующих шарниров.
Аргументы с 16 по 21 это ускорения соответствующих шарниров.

255: прекращение движения робота и завершение текущего сеанса работы

пример:
```
"1040 255 0"
```
| VERSION | COMMAND | COUNT_OF_ARGS |
| ------- | ------- | ------------- |
|    1040 |     255 |             0 |


## Ответ сервера (сервер - робот, клиент - PC)

Ответом является строка, в которой разделенные пробелом перечислены следующие параметры (в конце строки есть завершающий пробел):

> VERSION

Значение должно быть 1040 (т.к. в AS программе это значение жестко прописано).

> ERROR

Код ошибки (значение см. в APPENDIX 1 ERROR CODES мануала AS) или 0, если ошибки не было.

> SWITCH(RUN)

Отображает состояние переключателя `RUN/HOLD` на панели контроллера (-1 значит, что переключатель в позиции `RUN`, 0 - `HOLD`).

> SWITCH(REPEAT)

Отображает состояние переключателя `TEACH/REPEAT` на панели контроллера (-1 значит, что переключатель в позиции `REPEAT`, 0 - `TEACH`).

> SWITCH(TEACH_LOCK)

Отображает состояние переключателя `TEACH LOCK` на пульте (-1 значит, что переключатель `ON`, 0 - `OFF`).

> SWITCH(POWER)

Отображает состояние кнопки `MOTOR POWER` на панели контроллера (-1 значит, что переключатель `ON`, 0 - `OFF`).

> TASK(1) == 1

Если задача `Robot 1` выполняется в данный момент, то будет -1, иначе будет 0.

> TIMER(1)

Текущее значение таймера #1 (время, которое прошло с момента установления соединения, в секундах).

> JT1, JT2, JT3, JT4, JT5, JT6

6 параметров, которые определяют значения углов шарниров (значения с энкодеров) в градусах.

Пример:
```
"1040 0 -1 -1 -1 -1 -1 10 0 0 0 0 0 0 "
```
| VERSION | ERROR | SWITCH(RUN) | SWITCH(REPEAT) | SWITCH(TEACH_LOCK) |
| ------- | ----- | ----------- | -------------- | ------------------ |
|    1040 |     0 |          -1 |             -1 |                 -1 |

| SWITCH(POWER) | TASK(1) == 1 | TIMER(1) |
| ------------- | ------------ | -------- |
|            -1 |           -1 |       10 |

| JT1 | JT2 | JT3 | JT4 | JT5 | JT6 |
| --- | --- | --- | --- | --- | --- |
|   0 |   0 |   0 |   0 |   0 |   0 |